                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title> </title>
<link href="css/style.css" rel="stylesheet" type="text/css">
<script src="http://ece.ubc.ca/~kbajaj/cpen400a/jquery.js" type="text/javascript"></script>

<script type="text/javascript">

    function addToCart(itemName)
    {
        resetInactiveTime()
        m = products[itemName];
        n = cart[itemName];
        if (!m || !m.quantity)
        {
            alert("Sorry, but " + itemName + " is out of stock");
            return;
        }

        if (!n)
        {
            n = 1;
            showButtonRem(true, itemName);
        }
        else
        {
            n = n + 1;
        }
        cart[itemName] = n;

        if (m.quantity == n)
            showButtonAdd(false, itemName);

        cartSum = cartSum + m.price;
        cartCount = cartCount + 1;
        UpdateCartSum(cartSum);
    }
    function removeFromCart(itemName)
    {
        resetInactiveTime()
        n = cart[itemName];
        if (n)
        {
            if (n == 1) {
                delete cart[itemName];
                showButtonRem(false, itemName);
            }
            else
                cart[itemName] = n - 1;

            p = products[itemName];

            if (p.quantity == n)
                showButtonAdd(true, itemName);

            cartSum = cartSum - p.price;
            cartCount = cartCount - 1;
            UpdateCartSum(cartSum);
        }
        else {
            alert("There is no " + itemName + " in  cart");
        }
    }

    function showButtonAdd(visible, id)
    {
        e = document.getElementById(id).getElementsByClassName("add");
        if (!e) return;

        if (visible)
            e[0].style.visibility = 'visible';
        else
            e[0].style.visibility = 'hidden';
    }
    function showButtonRem(visible, id) {
        e = document.getElementById(id).getElementsByClassName("rem");
        if (!e) return;

        if (visible)
            e[0].style.visibility = 'visible';
        else
            e[0].style.visibility = 'hidden';
    }
</script>
</head>
<body>
    <script type="text/javascript">
        var showingCart = false;
        var confirming = false;
        var inactiveTime = 0;
        var cartSum = 0;
        var cartCount = 0;
        var cart = {};

        var products = {};
    </script>
<div id="header">

	<div id="logo">
		BookStore
	</div>

	<div id="welcomeBanner">
		Welcome to my bookstore
        <button id="buttonShowCart" onclick="showCart(true)">Cart($0)</button>

        <script type="text/javascript">
            function UpdateCartSum(sum)
            {
                e = document.getElementById("buttonShowCart");
                e.innerText = "Cart($" + sum + ")";
            }
        </script>
	</div>

    </div>

    <div id="mainContent">

        <div id="navigationMenu">
            <a>All Items</a>
            <a>Books</a>
            <a>Clothing</a>
            <a>Tech</a>
            <a>Gifts</a>
            <a>Stationary</a>
            <a>Supplies</a>
        </div>

        <div id="productList">
        </div>
    </div>

    <div id="footer">
        Inactive Time: 0 seconds
    </div>
    <script type="text/javascript">

        fetchProductsList("https://cpen400a.herokuapp.com/products", 3, function (data) {
            products = data;
            // query price for each product
            el = document.getElementById("productList")
            for (item in products)
            {
                p = products[item];

                e = document.createElement("div");
                e.setAttribute("class", "product");
                e.setAttribute("id", item);

                e1 = document.createElement("img");
                e1.setAttribute("src", p['url']);
                e.appendChild(e1);

                e1 = document.createElement("img");
                e1.setAttribute("src", "images/cart.png");
                e1.setAttribute("class", "cart");
                e.appendChild(e1);

                e1 = document.createElement("button");
                e1.setAttribute("class", "add");
                e1.setAttribute("onclick", "addToCart('" + item + "')");
                e1.innerText = "Add";

                // check inventory
                if (p['quantity'])
                    e1.style.visibility = 'visible';
                else
                    e1.style.visibility = 'hidden';

                e.appendChild(e1);

                e1 = document.createElement("button");
                e1.setAttribute("class", "rem");
                e1.setAttribute("onclick", "removeFromCart('" + item + "')");
                e1.innerText = "Remove";
                e.appendChild(e1);

                e1 = document.createElement("div");
                e1.className = "price";
                e1.id = "price" + item;
                e1.innerText = "$" + p['price'];
                e.appendChild(e1);

                e1 = document.createElement("h4");
                e1.innerText = item;
                e.appendChild(e1);

                el.appendChild(e);
            }
        });


        // handle esc for cart for the bounus
        window.onkeydown = function (event) {
            if (showingCart && event.keyCode === 27)
            {
                showCart(false);
            }
        };

        function fetchProductsList(uri, timeout, callback) {
            $.ajax({
                url: uri,
                success: function (data) {
                    //called when successful
                    callback(data);
                },
                error: function (e) {
                    //called when there is an error
                    //console.log(e.message);
                    if (timeout > 0)
                    {
                        timeout = timeout - 1;
                        fetchProductsList(uri, timeout, callback);
                    }
                    else
                    {
                        alert("Fetch product lists failed, please retry later");
                    }
                }
            });
        }

        function resetInactiveTime() {
            inactiveTime = 0;
        }
        function updateInactiveTime() {
            if (showingCart) return;

            inactiveTime = inactiveTime + 1;
            showInactiveTime(inactiveTime);

            if (inactiveTime > 3000) {
                alert("Hey there! Are you still planning to buy something?");
                inactiveTime = 0;
            }
        }
        function showInactiveTime(t)
        {
            e = document.getElementById("footer");
            e.innerText = "Inactive Time: " + t + " seconds";
        }

        // do the monitor job
        setInterval(updateInactiveTime, 1000);

        function showCart(visible) {
            el = document.getElementById("cart");
            if (visible)
            {
                showingCart = true;
                el.style.display = 'block';
                showCartInfo();
            }
            else
            {
                showingCart = false;
                el.style.display = 'none';
            }
        }

        function showCartInfo() {
            cartInfoEl = document.getElementById("cartInfo");
            cartInfoHtml = "";
            for (product in cart)
            {
                count = cart[product];
                if (count) {
                    cartInfoHtml = cartInfoHtml +
                        ("\n<div id='inCart" + product + "' class='productCount'><span>" + product + "</span><span class='updater'><button class='update' onClick=\"addProductInCart('" + product + "',-1)\">-</button><span id='inCartCount" + product + "'>" + count + "</span><button class='update' onClick=\"addProductInCart('" + product + "',1)\">+</button></span></div>");
                }
            }

            if (cartCount == 0)
                cartInfoEl.innerText = "nothing here...";
            else
                cartInfoEl.innerHTML = cartInfoHtml;

            cartSubtotal();
        }
        function addProductInCart(itemName, number)
        {
            if (number > 0)
                addToCart(itemName);
            else
                removeFromCart(itemName);

            updateProductQuantityInCart(cart[itemName]);
            cartSubtotal();
        }

        function updateProductQuantityInCart(itemName, n)
        {
            if (!showingCart) return;
            if (!n) {
                // delete it from cart
                cartInfoEl = document.getElementById("cartInfo");
                el = document.getElementById("inCart" + itemName);
                cartInfoEl.removeChild(el);
            }
            else {
                el = document.getElementById("inCartCount" + itemName);
                el.innerText = n;
            }
        }
        function cartSubtotal()
        {
            if (!showingCart) return;
            // show sum
            el = document.getElementById("cartSum");
            el.innerText = "Subtotal (" + cartCount + " items): $" + cartSum;
        }

        function confirm()
        {
            if (confirming)
                return;

            confirming = true;

            fetchProductsList("https://cpen400a.herokuapp.com/products", 3, function (data) {

                changedPrice = "";
                changedQuantity = "";
                for (item in data)
                {
                    // previouse products info
                    i1 = products[item];

                    // latest product info
                    i2 = data[item];

                    q1 = i1['quantity'];
                    q2 = i2['quantity'];

                    p1 = i1['price'];
                    p2 = i2['price'];

                    // item in cart
                    q3 = cart[item];

                    if (q1 != q2 || p1 != p2)
                    {
                        // update quantity
                        if (q2 > q1)
                        {
                            showButtonAdd(true, item);
                        }
                        else if (q2 < q1)
                        {
                            if (q3 && q3 > q2)
                            {
                                //: alert user
                                changedQuantity = changedQuantity + item + ": " + q3 + "->" + q2 + "\n";

                                // we only have this
                                cart[item] = q2;
                                updateProductQuantityInCart(item, q2);

                                if (q3 < q1)
                                {
                                    // we thought it was sufficient
                                    showButtonAdd(false, item);
                                }
                            }
                        }
                        if (q2 == 0)
                        {
                            // this product was removed from cart
                            showButtonRem(false, item);
                        }

                        // update price
                        if (p1 != p2)
                        {
                            document.getElementById("price" + item).innerText = "$" + p2;
                            if (q3)
                            {
                                //: alert user
                                changedPrice = changedPrice + item + ": $" + p1 + " -> $" + p2 + "\n";
                            }
                        }

                        
                        // update product info
                        products[item] = i2;
                    }
                }

                // recaculate price
                cartSum = 0;
                cartCount = 0;
                for (p in cart)
                {
                    cartCount = cartCount + cart[p];
                    cartSum = cartSum + cart[p] * products[p].price;
                }
                UpdateCartSum(cartSum);
                cartSubtotal();

                // alert all changes to user
                if (changedPrice.length)
                {
                    changedPrice = "These items in your Cart have changed price\n" + changedPrice + "\n";
                }
                if (changedQuantity.length)
                {
                    changedQuantity = "These items in your Cart have changed quantity:\n" + changedQuantity;
                }
                if (changedPrice.length > 0 || changedQuantity.length > 0)
                    alert(changedPrice + changedQuantity);
                else
                    alert("Nothing changed!");
                confirming = false;
            });

            alert("Confirming...");

        }
    </script>

    <div class="modalCart" id="cart">
        <div class="box">
            <button class="close" onclick="showCart(false)">X</button>
            <p class="title">See what's in your cart</p>
            <div class="content" id="cartInfo">
            </div>
            <div class="foot">
                <span id="cartSum"></span>
                <button class="checkout" onclick="confirm()">Check out</button>
            </div>

        </div>
    </div>

    </body>
    </html>
